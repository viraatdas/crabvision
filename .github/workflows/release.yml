name: Release

on:
  push:
    tags:
      - "v*"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      publish:
        description: "Publish to PyPI (use with care)"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  wheels:
    name: Build wheels (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.22.0
        env:
          CIBW_BUILD: cp38-* cp39-* cp310-* cp311-* cp312-*
          CIBW_SKIP: "pp* *-musllinux*"
          # Avoid 32-bit Linux (i686) which is not a release target.
          CIBW_ARCHS_LINUX: x86_64
          CIBW_BEFORE_ALL_LINUX: >-
            curl -sSf https://sh.rustup.rs | sh -s -- -y &&
            . "$HOME/.cargo/env" &&
            rustc --version
          CIBW_ENVIRONMENT_LINUX: PATH="$HOME/.cargo/bin:$PATH"
          CIBW_TEST_COMMAND: >-
            python -c "import cv2; print(cv2.__version__)"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: crabvision-wheels-${{ matrix.os }}
          path: wheelhouse/*.whl

  sdist:
    name: Build sdist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build sdist
        run: |
          python -m pip install --upgrade pip
          python -m pip install "maturin>=1,<2"
          maturin sdist --out dist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: crabvision-sdist
          path: dist/*.tar.gz

  publish:
    name: Publish to PyPI
    needs: [wheels, sdist]
    runs-on: ubuntu-latest
    if: >-
      startsWith(github.ref, 'refs/tags/v') ||
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.publish == 'true')
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Verify tag matches version
        if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release'
        run: |
          python - <<'PY'
          import os
          import tomllib

          tag = os.environ.get("GITHUB_REF_NAME") or os.environ.get("GITHUB_REF") or ""
          if tag.startswith("refs/tags/"):
              tag = tag.removeprefix("refs/tags/")
          with open("pyproject.toml", "rb") as f:
              version = tomllib.load(f)["project"]["version"]

          expected = f"v{version}"
          if tag != expected:
              raise SystemExit(
                  f"Refusing to publish: tag '{tag}' does not match pyproject.toml version '{version}' (expected '{expected}')."
              )
          print(f"Tag/version OK: {tag}")
          PY

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten dist directory
        run: |
          mkdir -p publish_dist
          find dist -type f \( -name '*.whl' -o -name '*.tar.gz' \) -exec cp -v {} publish_dist/ \;
          ls -la publish_dist

      - name: Publish crabvision
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: publish_dist
          skip-existing: true
